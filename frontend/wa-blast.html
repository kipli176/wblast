<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WA Blast App</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

  <!-- Header -->
  <header class="bg-green-600 text-white p-4 shadow-md">
    <div class="flex items-center justify-between">
      <h1 class="text-lg font-bold">WhatsApp Blast</h1>
      <div id="conn-status" class="flex items-center gap-2 text-sm">
        <span id="conn-dot" class="w-3 h-3 rounded-full bg-red-500"></span>
        <span id="conn-text">Disconnected</span>
      </div>
    </div>
  </header>

  <!-- Tabs -->
  <div class="flex bg-white shadow-sm text-sm">
  <button class="tab-btn flex-1 py-2 font-semibold border-b-2 border-green-600" data-tab="blast">Blast</button>
  <button class="tab-btn flex-1 py-2 text-gray-600 border-b-2 border-transparent" data-tab="history">Histori</button>
  <button class="tab-btn flex-1 py-2 text-gray-600 border-b-2 border-transparent" data-tab="api">API</button>
</div>


  <main class="flex-1 p-4 space-y-4 overflow-y-auto">

    <!-- QR Panel -->
    <div id="qr-panel" class="bg-white rounded-2xl shadow p-4 hidden">
      <h2 class="font-bold mb-2">Pairing - Scan QR</h2>
      <p class="text-sm text-gray-600 mb-3">Scan QR ini dengan WhatsApp untuk login.</p>
      <img id="qr-img" class="w-48 h-48 border rounded bg-white" />
    </div>

    <!-- Tab: Blast -->
    <div id="tab-blast" class="space-y-4">

      <!-- Kontak -->
      <div class="bg-white rounded-2xl shadow p-4">
        <h2 class="font-bold mb-2">Kontak Tujuan</h2>
        <label class="block text-sm mb-1">Nomor manual (pisahkan dengan koma)</label>
        <textarea id="manual-numbers" rows="2" placeholder="62812345,62898765" class="w-full border rounded p-2"></textarea>

        <div class="mt-3">
          <label class="block text-sm mb-1">Upload CSV/VCF</label>
          <input type="file" id="file-upload" class="w-full border rounded p-2 text-sm" accept=".vcf,.csv" />
        </div>

        <div class="mt-3">
          <label class="block text-sm mb-1">Pilih dari daftar kontak</label>
          <select id="contact-select" multiple class="w-full border rounded p-2 text-sm">
            <option value="6281111111">+62 811 111 111</option>
            <option value="6282222222">+62 822 222 222</option>
            <option value="6283333333">+62 833 333 333</option>
          </select>
        </div>
      </div>

      <!-- Pesan -->
      <div class="bg-white rounded-2xl shadow p-4">
        <h2 class="font-bold mb-2">Tulis Pesan</h2>
        <!-- Toolbar -->
        <div class="flex gap-2 mb-2">
  <button class="toolbar-btn px-2 py-1 border rounded text-sm" data-tag="b"><b>B</b></button>
  <button class="toolbar-btn px-2 py-1 border rounded text-sm italic" data-tag="i">I</button>
  <button class="toolbar-btn px-2 py-1 border rounded text-sm underline" data-tag="u">U</button>
  <select id="emoji-picker" class="border rounded p-1 text-sm">
    <option value="">üòä</option>
    <option>üî•</option>
    <option>‚ù§Ô∏è</option>
    <option>üëç</option>
    <option>üòä</option>
    <option>üéâ</option>
    <option>üí°</option>
  </select>
</div>

        <textarea id="message" rows="4" placeholder="Isi pesan blast..." class="w-full border rounded p-2"></textarea>
        <div class="mt-3 grid grid-cols-3 gap-2">
          <button id="btn-spin" class="px-3 py-2 bg-indigo-600 text-white rounded">üé≤ Spin Kata</button>
          <select id="spin-mode" class="border rounded p-2 text-sm">
            <option value="prepend">Tambah Depan</option>
            <option value="append">Tambah Belakang</option>
            <option value="both">Keduanya</option>
          </select>
          <button id="btn-preview" class="px-3 py-2 bg-gray-200 rounded">Preview</button>
        </div>
        <div id="spin-preview" class="mt-2 text-sm text-gray-700 hidden border rounded p-2 bg-gray-50"></div>
      </div>

      <!-- Delay -->
      <div class="bg-white rounded-2xl shadow p-4">
        <h2 class="font-bold mb-2">Pengaturan</h2>
        <label class="block text-sm">Delay antar pesan (detik)</label>
        <input type="number" id="delay" value="5" min="1" class="w-full border rounded p-2">
        <label class="flex items-center gap-2 mt-2"><input type="checkbox" id="opt-randomize"> Random urutan nomor</label>
        <label class="flex items-center gap-2 mt-1"><input type="checkbox" id="opt-log" checked> Tampilkan log realtime</label>
      </div>

      <!-- Tombol Kirim -->
      <button id="send-blast" class="w-full bg-green-600 text-white py-3 rounded-full font-semibold shadow active:scale-95 transition">
        üöÄ Kirim Blast
      </button>

      <!-- Log -->
      <div id="log" class="bg-white rounded-2xl shadow p-4 hidden max-h-64 overflow-y-auto">
        <h2 class="font-bold mb-2">Log Pengiriman</h2>
        <ul id="log-list" class="text-sm text-gray-700 space-y-1"></ul>
      </div>
    </div>

    <!-- Tab: History -->
    <div id="tab-history" class="hidden">
      <div class="bg-white rounded-2xl shadow p-4">
        <h2 class="font-bold mb-2">Histori Blast</h2>
        <ul id="history-list" class="text-sm text-gray-700 divide-y"></ul>
      </div>
    </div>
    
<!-- Tab: API -->
<div id="tab-api" class="hidden">
  <div class="bg-white rounded-2xl shadow p-4 space-y-4">
    <h2 class="font-bold mb-2">Dokumentasi API</h2>
    <p class="text-sm text-gray-600">Gunakan endpoint berikut untuk integrasi dengan sistem lain:</p>

    <pre class="bg-gray-100 p-3 rounded text-sm overflow-auto"><code>POST /send-message
Content-Type: application/json

{
  "number": "628123456789",
  "message": "Halo, ini pesan blast!"
}</code></pre>

    <pre class="bg-gray-100 p-3 rounded text-sm overflow-auto"><code>POST /send-batch
Content-Type: application/json

{
  "numbers": ["6281111111","6282222222"],
  "message": "Promo spesial hari ini!"
}</code></pre>

    <pre class="bg-gray-100 p-3 rounded text-sm overflow-auto"><code>GET /logs

Respon:
{
  "status": "ok",
  "logs": [ ... ]
}</code></pre>

    <p class="text-xs text-gray-500">‚ö†Ô∏è Pastikan backend berjalan di <code>http://localhost:3000</code> atau sesuaikan URL.</p>
  </div>
</div>

  </main>

  <footer class="p-3 text-xs text-gray-500 text-center">
    Prototype UI ‚Äî backend Node.js Baileys di <code>http://localhost:3000</code>
  </footer>

  <!-- Script -->
  <script>
    const WS_URL = "wss://wblast.sukipli.work";
    const API_URL = "https://wblast.sukipli.work";

    const OPENERS = [
  "Halo {name},",
  "Hai {name},",
  "Selamat pagi {name},",
  "Selamat siang {name},",
  "Selamat sore {name},",
  "Selamat malam {name},",
  "Apa kabar {name}?",
  "Semoga sehat selalu {name},",
  "Kabar baik untukmu {name},",
  "Halo sahabat {name},",
  "Hai kak {name},",
  "Halo bro {name},",
  "Selamat datang kembali {name},",
  "Senang bisa menyapamu {name},",
  "Salam hangat {name},",
  "Assalamualaikum {name},",
  "Shalom {name},",
  "Hi {name}, good day!",
  "Morning {name},",
  "Evening {name},"
];

const CLOSERS = [
  "Terima kasih {name}.",
  "Salam hangat untukmu {name}.",
  "Ditunggu kunjungannya {name}!",
  "Semoga harimu menyenangkan, {name}.",
  "Jangan ragu hubungi kami ya {name}.",
  "Sukses selalu {name}!",
  "Sehat selalu untukmu {name}.",
  "Salam sukses {name}.",
  "Kami tunggu kabar baik darimu {name}.",
  "Have a nice day {name}!",
  "See you soon {name}!",
  "Sampai jumpa {name}.",
  "Maju terus {name}!",
  "Tetap semangat {name}!",
  "Salam persahabatan {name}.",
  "Best regards, {name}.",
  "Keep in touch {name}.",
  "Salam bahagia {name}.",
  "Semoga selalu diberkahi {name}.",
  "Salam dari kami untukmu {name}."
];


    function getRandom(arr) { return arr[Math.floor(Math.random()*arr.length)]; }

    function log(msg, cls) {
      if (!$("#opt-log").is(":checked")) return;
      $("#log").removeClass("hidden");
      const time = new Date().toLocaleTimeString();
      $("#log-list").append(`<li class="${cls||''}"><span class="text-xs text-gray-400">[${time}]</span> ${msg}</li>`);
      $("#log").scrollTop($("#log")[0].scrollHeight);
    }

    // Tabs
    $(".tab-btn").on("click", function(){
      $(".tab-btn").removeClass("border-green-600 text-black").addClass("text-gray-600 border-transparent");
      $(this).addClass("border-green-600 text-black").removeClass("text-gray-600");
      const tab = $(this).data("tab");
      $("#tab-blast, #tab-history").addClass("hidden");
      $("#tab-"+tab).removeClass("hidden");
      if(tab==="history") loadHistory();
    });

    // Spin Kata
    $("#btn-spin").on("click", function() {
      const base = $("#message").val();
      const opener = getRandom(OPENERS);
      const closer = getRandom(CLOSERS);
      let newMsg = base;
      const mode = $("#spin-mode").val();
      if (mode==="prepend") newMsg = opener+" "+base;
      else if (mode==="append") newMsg = base+" "+closer;
      else newMsg = opener+" "+base+" "+closer;
      $("#message").val(newMsg);
      $("#spin-preview").html(newMsg).removeClass("hidden");
    });
    $("#btn-preview").on("click", () => $("#spin-preview").toggleClass("hidden"));

    // Toolbar formatting
    $(".toolbar-btn").on("click", function(){
      const tag = $(this).data("tag");
      const textarea = document.getElementById("message");
      const start = textarea.selectionStart;
      const end = textarea.selectionEnd;
      const selected = textarea.value.substring(start, end);
      const before = textarea.value.substring(0, start);
      const after = textarea.value.substring(end);
      textarea.value = before + `<${tag}>`+selected+`</${tag}>` + after;
    });
    // Emoji picker
$("#emoji-picker").on("change", function(){
  const emoji = $(this).val();
  if (!emoji) return;
  const textarea = document.getElementById("message");
  const start = textarea.selectionStart;
  const end = textarea.selectionEnd;
  const before = textarea.value.substring(0, start);
  const after = textarea.value.substring(end);
  textarea.value = before + emoji + after;
  textarea.focus();
  $(this).val(""); // reset ke default
});

function loadContacts() {
  $.get(API_URL+"/contacts", (res)=>{
    if(res.status==="ok"){
      $("#contact-select").empty();
      Object.values(res.contacts).forEach(c=>{
        const num = c.id.split('@')[0];
        $("#contact-select").append(`<option value="${num}">${c.name || num}</option>`);
      });
    }
  });
}


    // Gather numbers
    function gatherNumbers() {
      let numbers = [];
      const manual = $("#manual-numbers").val().trim();
      if (manual) {
        numbers = numbers.concat(manual.split(",").map(n=>n.replace(/[^0-9]/g,"")));
      }
      const sel = $("#contact-select").val() || [];
      numbers = numbers.concat(sel);
      return Array.from(new Set(numbers.filter(Boolean)));
    }

    // Kirim Blast
    $("#send-blast").on("click", function() {
      const message = $("#message").val().trim();
      const numbers = gatherNumbers();
      if (!message || numbers.length===0) { alert("Isi pesan & nomor!"); return; }
      const randomize = $("#opt-randomize").is(":checked");
      let list = [...numbers];
      if (randomize) list.sort(()=>Math.random()-0.5);

      log(`üöÄ Mulai blast ke ${list.length} nomor.`);

      $.ajax({
        url: API_URL+"/send-batch",
        method: "POST",
        contentType: "application/json",
        data: JSON.stringify({ numbers:list, message }),
        success: (res) => {
          log(`‚úîÔ∏è ${res.total} nomor dimasukkan ke antrian.`);
        },
        error: () => {
          log("‚ùå Gagal request ke backend.");
        }
      });
    });

    // WebSocket
    let ws;
    function connectWS(){
      ws = new WebSocket(WS_URL);
      ws.onmessage = (evt)=>{
        try {
          const data = JSON.parse(evt.data);
          if (data.type==="status"){
            if (data.status==="connected"){
              $("#conn-dot").removeClass("bg-red-500").addClass("bg-green-400");
              $("#conn-text").text("Connected");
              $("#qr-panel").addClass("hidden");
            } else {
              $("#conn-dot").removeClass("bg-green-400").addClass("bg-red-500");
              $("#conn-text").text("Disconnected");
            }
          }
          if (data.type==="qr"){ $("#qr-panel").removeClass("hidden"); $("#qr-img").attr("src", data.qr); }
// update via WebSocket
if (data.type==="contacts") {
  $("#contact-select").empty();
  Object.values(data.contacts).forEach(c=>{
    const num = c.id.split('@')[0];
    $("#contact-select").append(`<option value="${num}">${c.name || num}</option>`);
  });
}
          if (data.type==="log"){ log(data.msg); }
        } catch(e){ console.error(e); }
      }
      ws.onclose = ()=> { $("#conn-dot").removeClass("bg-green-400").addClass("bg-red-500"); $("#conn-text").text("Disconnected"); setTimeout(connectWS,3000); };
    }
    connectWS();

    // Load history
    function loadHistory(){
      $.get(API_URL+"/logs", (res)=>{
        const list = res.logs || [];
        $("#history-list").empty();
        list.slice(-50).reverse().forEach(log=>{
          const status = log.status==="success" ? "text-green-600" : "text-red-600";
          $("#history-list").append(`<li class="py-1"><span class="${status}">${log.status.toUpperCase()}</span> - ${log.to} - ${log.message || log.error} <span class="text-xs text-gray-400">(${new Date(log.time).toLocaleString()})</span></li>`);
        });
      });
    }
  </script>
</body>
</html>
